# ml-plpython

## Описание проекта
Пример проекта решения задач машинного обучения с использованием PL/Python-процедур базы данных Postgres.
Проект реализован в виде готового к использованию Dockerfile со всеми необходимыми инструкциями и данными

## Machine Learning
Решается задача бинарной класиификации - прогнозирование (вероятности) оттока клиентов банка. 
Исходные данные взяты из [Kaggle](https://www.kaggle.com/datasets/mathchi/churn-for-bank-customers).
Для данных выполнена базовая преподготовка и разделение на обучающую и проверочную выборки.
В качестве ML-модели используется CatBoost с оптимизацией гиперпараметров в Optuna.
В цели данного исследования не входило достижение как можно более высокой оценки качества прогнозирования.
Важно было получить наработки по реализации основных этапов обучения и прогнозирования ML-моделей с помощью
PL/Python-процедур базы данных Postgres

## Реализация проекта
`Dockerfile` в проекте создает docker образ на базе официального образа Postgres 13 и устанавливает минимально 
необходимые пакеты. Далее создается виртуальное окружение, в которое будут установлены дополнительные
библиотеки, используемые для решения задачи машинного обучения. Список библиотек содержится в файле
`requirements.txt`. Сырые данные, предварительно разделенные на обучающую `raw_train_data.csv` и проверочную 
`raw_test_data.csv` выборки, копируются внутрь создаваемого контейнера по указанному пути. В соответствующую
директорию копируется скрипт инициализации объектов PG `init.sql` - этот скрипт будт выполнен при первом
запуске созданного из образа контейнера

## Инициализация таблиц и расширений, загрузка данных в Postgres
При выполнении скрипта `init.sql` при первом запуске контейнера последовательно создаются:
- ml - обособленная схема данных `ml` для задач машинного обучения
- ml.raw_train_data - таблица для хранения сырых данных для обучения
- ml.raw_test_data - таблица для хранения сырых данных для прогнозирования
- ml.x_train - таблица для хранения подготовленных данных для обученяи
- ml.x_test - таблица для хранения подготовленных данных для прогнозирования
- ml.predictions - таблица для записи результатов прогнозирования
- ml.model_score - таблица для хранения параметров и оценок качества обучаемых моделей
- plpython3u - расширение pl/python для использования языка python в процедурах PG

Загрузка в таблицы сырых данных для обучения и прогнозирования имитируется копированием содержимого
перенесенных файлов с выборками в соответствующие таблицы. Загрузка выполнится автоматически при запуске
контейнера

## Инициализация ML процедур
Собственно процесс подготовки выборок и обучения моделей реализуется PL/Python-процедурами:
- ml.make_x_train() - выполняет подготовку данных для обучения
- ml.make_x_test() - выполняет подготовку данных для прогнозирования
- ml.make_model() - обучение и оптимизация гиперпараметров модели.
  Скоринг и параметры записываются в таблицу `ml.model_score`.
  Обученная модель сохраняется в директорию для хранения данных PG
- ml.make_predictions() - выполняет прогнозирование на данных, хранящихся в таблице `ml.x_test`.
  Результат выполнения сохраняется в таблицу `ml.predictions`

## Создание образа
Для создания образа в терминале в директории с Dockerfile выполнить команду:
```bash
docker build -t pgpy .
```

## Запуск контейнера
Для запуска контейнера после создания образа выполнить команду:
```bash
docker run -d --name pgpy -p 5433:5432 pgpy
```

## Выполнение ML процедур
Для получения результатов прогнозирования подключиться к PG и последовательно выполнить запросы:
```SQL
-- подготавливаем данные для обучения
SELECT ml.make_x_train();
-- подготавливаем данные для прогнозирования
SELECT ml.make_x_test();
-- обучаем и сохраняем модель
SELECT ml.make_model();
-- выполняем прогнозирование
SELECT ml.make_predictions();
```


